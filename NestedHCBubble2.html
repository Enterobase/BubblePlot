<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>HC200 â†’ HC100 Bubble Plot</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      background: #fafafa;
    }

    #chart {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    h2 {
      margin: 12px 0 6px;
      text-align: center;
      font-weight: 600;
    }

    svg {
      display: block;
      margin: auto;
    }

    #legend {
      width: 280px;
      height: 100vh;
      overflow-y: auto;
      background: #fff;
      border-left: 1px solid #ddd;
      padding: 10px;
    }

    #legend h3 {
      margin-top: 0;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      font-size: 12px;
      cursor: pointer;
    }

    .legend-color {
      width: 14px;
      height: 14px;
      margin-right: 8px;
      flex-shrink: 0;
    }

    .tooltip {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      padding: 6px 10px;
      font-size: 12px;
      pointer-events: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      opacity: 0;
    }
  </style>
</head>
<body>

<div id="chart">
  <!-- ðŸ‘‡ Heading inserted here -->
  <h2 id="plot-title"></h2>

  <svg width="900" height="900"></svg>
</div>

<div id="legend">
  <h3>HC200 clusters</h3>
  <div id="legend-items"></div>
</div>

<div class="tooltip"></div>

<script>
const width = 900;
const height = 900;

const svg = d3.select("svg")
  .attr("viewBox", [0, 0, width, height]);

const tooltip = d3.select(".tooltip");

const pack = d3.pack()
  .size([width, height])
  .padding(3);

d3.json("hc200_hc100_d3.json").then(data => {

  const root = d3.hierarchy(data);

  // compute total strains from raw HC500 values
  const hc200Nodes = root.children;
  // Compute total strains from HC100 leaves
  const totalStrains = d3.sum(
    root.descendants().filter(d => !d.children),
    d => d.data.value
  );

  console.log(
    "HC200 raw total:",
    d3.sum(hc200Nodes, d => d.data.value)
  );

  console.log(
    "HC100-derived total:",
    d3.sum(
      root.descendants().filter(d => !d.children),
      d => d.data.value
    )
  );


  // now do layout math
  root.sum(d => d.children ? 0 : d.value)
    .sort((a, b) => b.value - a.value);

  pack(root);

  // set title
  d3.select("#plot-title")
  .text(
    `HC200 â†’ HC100 Bubble Plot (Total strains: ${totalStrains.toLocaleString()})`
  );


  const color = d3.scaleOrdinal()
    .domain(hc200Nodes.map(d => d.data.name))
    .range(d3.schemeTableau10.concat(d3.schemeSet3, d3.schemePaired));

  // -----------------------
  // Draw bubbles
  // -----------------------
  const node = svg.selectAll(".node")
    .data(root.descendants().filter(d => d.depth > 0))
    .enter()
    .append("g")
    .attr("class", "node")
    .attr("transform", d => `translate(${d.x}, ${d.y})`);

  const circles = node.append("circle")
    .attr("r", d => d.r)
    .attr("fill", d =>
      d.depth === 1
        ? color(d.data.name)
        : color(d.parent.data.name)
    )
    .attr("stroke", "none");

  const BASE_OPACITY = d => d.depth === 1 ? 0.35 : 0.85;
  circles.attr("fill-opacity", BASE_OPACITY);

  // -----------------------
  // Tooltip + hover highlight
  // -----------------------
  circles
    .on("mouseover", (event, d) => {
      const hc200 = d.depth === 1 ? d.data.name : d.parent.data.name;

      tooltip
        .style("opacity", 1)
        .html(`
          <strong>${d.data.name}</strong><br/>
          HC200: ${hc200}<br/>
          Strains: ${d.value.toLocaleString()}
        `);

      circles.attr("fill-opacity", 0.15);

      circles
        .filter(c =>
          (c.depth === 1 && c.data.name === hc200) ||
          (c.depth === 2 && c.parent.data.name === hc200)
        )
        .attr("fill-opacity", c => c.depth === 1 ? 0.6 : 1);
    })
    .on("mousemove", event => {
      tooltip
        .style("left", (event.pageX + 12) + "px")
        .style("top", (event.pageY + 12) + "px");
    })
    .on("mouseout", () => {
      tooltip.style("opacity", 0);
      circles.attr("fill-opacity", BASE_OPACITY);
    });

  // -----------------------
  // Scrollable legend (HC500)
  // -----------------------
  const legend = d3.select("#legend-items");

  const legendItem = legend.selectAll(".legend-item")
    .data(hc200Nodes)
    .enter()
    .append("div")
    .attr("class", "legend-item")
    .on("mouseover", (event, d) => {
      circles.attr("fill-opacity", 0.15);

      circles
        .filter(c =>
          (c.depth === 1 && c.data.name === d.data.name) ||
          (c.depth === 2 && c.parent.data.name === d.data.name)
        )
        .attr("fill-opacity", c => c.depth === 1 ? 0.6 : 1);
    })
    .on("mouseout", () => {
      circles.attr("fill-opacity", BASE_OPACITY);
    });

  legendItem.append("div")
    .attr("class", "legend-color")
    .style("background", d => color(d.data.name));

  legendItem.append("div")
    .html(d => `
      ${d.data.name}<br/>
      <span style="color:#555">${d.value.toLocaleString()} strains</span>
    `);
});
</script>

</body>
</html>
